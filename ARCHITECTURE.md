# 系统架构文档 (System Architecture Documentation)

## 概述 (Overview)

AI主动弹制导系统是一个复杂的实时控制系统，采用模块化设计，分为多个功能组件协同工作。

## 核心模块 (Core Modules)

### 1. Program.cs - 主程序类

主程序类是整个系统的核心，负责协调所有子系统。

#### 主要职责：
- 系统初始化和组件发现
- 主循环控制和状态机管理
- 子系统协调
- 性能监控和诊断输出

#### 关键变量：
```csharp
private 参数管理器 参数们;              // 参数管理器
private 导弹识别器 导弹编组;            // 方块识别系统
private 导弹状态量 导弹状态信息;        // 状态机和状态数据
private TargetTracker 目标跟踪器;      // 目标预测系统
private 推进系统 推进器系统;            // 推进器控制
private 陀螺仪瞄准系统 陀螺仪;          // 姿态控制
```

#### 状态机流程：
```
初始化 → 待机 → 热发射 → 搜索 → 跟踪 → 制导 → 引爆
```

### 2. 参数管理器.cs - 参数管理系统

统一管理所有系统参数，提供集中的配置管理。

#### 参数分类：

**制导参数:**
- 导航常数（动态范围3-5）
- 角度误差阈值
- 预测时间限制
- 补偿项参数

**引爆参数:**
- 近炸距离阈值
- 碰炸解锁距离
- 碰炸敏感度

**控制参数:**
- PID增益参数
- 时间常数
- 输出限制

#### 特点：
- 所有参数集中管理
- 支持运行时读取自定义数据
- 提供默认值和验证

### 3. 导弹.cs - 状态管理系统

#### 导弹状态机枚举：
```csharp
public enum 导弹状态机
{
    初始化状态,    // 系统启动
    待机状态,      // 等待发射
    热发射阶段,    // 离架清除
    搜索目标,      // 主动搜索
    跟踪目标,      // 目标跟踪
    预测制导,      // 精确制导
    引爆激发,      // 第一阶段引爆
    引爆最终       // 最终引爆
}
```

#### 状态数据类：
```csharp
public class 导弹状态量
{
    导弹状态机 当前状态;
    导弹状态机 上次状态;
    Vector3D 制导命令;
    double 导弹最大过载;
    double 导航常数;
    bool 角度误差在容忍范围内;
    bool 等待二阶段引爆;
}
```

### 4. TargetTracker.cs - 目标跟踪系统

高级目标预测系统，支持多种运动模型。

#### 运动模型：

**1. 线性运动模型 (Linear Motion Model)**
```
位置预测: P(t) = P₀ + V₀*t + 0.5*a*t²
速度预测: V(t) = V₀ + a*t
```

**2. 圆周运动模型 (Circular Motion Model)**
```
检测圆周运动参数:
- 圆心位置 (Center)
- 半径 (Radius)
- 角速度 (Angular Velocity)
- 平面法向量 (Normal)

预测圆周位置:
θ(t) = θ₀ + ω*t
P(t) = Center + R*[cos(θ)*u + sin(θ)*v]
```

**3. 混合预测模型 (Hybrid Model)**
```
P_final = w_linear * P_linear + w_circular * P_circular
```
权重基于预测误差动态调整。

#### 关键功能：
- `UpdateTarget()`: 更新目标信息
- `PredictPosition()`: 预测未来位置
- `DetectCircularMotion()`: 检测圆周运动
- `CalculateClosingVelocity()`: 计算接近速度

### 5. 推进系统.cs - 推进器管理

管理和控制导弹的所有推进器。

#### 推进器分类：
```
六方向推进器组:
- XP / XN (X轴正/负方向)
- YP / YN (Y轴正/负方向)
- ZP / ZN (Z轴正/负方向)

特殊类型:
- 分离推进器（名称含"分离"）
```

#### 核心功能：

**1. 推进器分类**
```csharp
public void 分类推进器(IMyControllerCompat 控制器)
```
根据推力方向自动分类所有推进器。

**2. 推力控制**
```csharp
public void 设置推进器方向输出(Vector3D 归一化方向, double 输出百分比)
```
按方向向量设置推进器输出。

**3. 最大加速度计算**
```csharp
public Vector3D 计算各轴最大加速度()
```
计算每个轴向的最大可用加速度。

#### 质量估算：
```csharp
public double 估算质量()
```
基于方块类型和网格大小估算总质量。

### 6. 陀螺仪系统.cs - 姿态控制系统

实现双环PID控制的姿态稳定系统。

#### 控制架构：

```
目标方向 → [外环PID] → 期望角速度 → [内环PID] → 陀螺仪输出
             (角度误差)                (角速度误差)
```

#### PID控制器：

**外环PID（角度控制）:**
- Kp = 5.0  (比例增益)
- Ki = 0.0  (积分增益)
- Kd = 4.0  (微分增益)

**内环PID（角速度控制）:**
- Kp = 2.0
- Ki = 0.3
- Kd = 0.15

#### 关键方法：

**1. 瞄准控制**
```csharp
public void 瞄准(Vector3D 世界方向, long 当前时间戳)
```
使陀螺仪转向指定世界坐标方向。

**2. 角度误差计算**
```csharp
private Vector3  计算角度误差(Vector3D 目标世界方向)
```
计算当前朝向与目标方向的角度误差（俯仰、偏航、滚转）。

**3. PID输出应用**
```csharp
private void 应用陀螺仪设置(Vector3 陀螺仪设定PYR)
```
将PID输出转换为陀螺仪控制信号。

### 7. 导弹识别器.cs - 方块识别系统

使用广度优先搜索（BFS）算法识别导弹上的所有方块。

#### BFS遍历算法：

```
1. 初始化：将起点方块加入队列
2. 循环处理：
   a. 从队列取出一个位置
   b. 检查该位置的方块
   c. 将相邻未访问位置加入队列
3. 持续直到队列为空
```

#### 分帧处理：
```csharp
public void 遍历分步执行(int 每帧最大处理数 = 100)
```
避免单帧处理过多方块导致性能问题。

#### 方块分类：
遍历过程中自动识别和分类：
- 推进器
- 陀螺仪
- 弹头
- 传感器
- 连接器/合并方块/转子
- 控制器
- AI模块

### 8. Utils.cs - 工具类库

提供各种辅助功能和数据结构。

#### PID控制器：
```csharp
public class PID
{
    double GetOutput(double error)  // 计算PID输出
    void SetOutputLimits()           // 设置输出限制
    void SetIntegralLimits()         // 设置积分限制
}
```

#### PID3控制器：
三轴PID控制器，用于姿态控制。

#### 移动平均队列：
```csharp
public class MovingAverageQueue<T>
```
实现滑动窗口平均值计算，用于数据平滑。

## 数据流 (Data Flow)

### 主循环数据流：

```
1. 传感器输入
   ├── AI模块 → 目标信息
   ├── 遥控器 → 位置/速度/方向
   └── 陀螺仪 → 角速度

2. 目标处理
   ├── TargetTracker.UpdateTarget()
   ├── 运动模型检测
   └── 位置预测

3. 制导计算
   ├── 计算视线角速度
   ├── 比例导航法
   ├── 补偿项计算
   └── 生成制导命令

4. 控制输出
   ├── 陀螺仪系统.瞄准()
   ├── 推进系统.设置推进器输出()
   └── 引爆系统检查

5. 状态更新
   └── 状态机转换
```

## 性能优化策略 (Performance Optimization)

### 1. 分帧处理
- BFS遍历每帧限制处理数量
- 密集计算分散到多帧
- 避免单帧耗时过长

### 2. 缓存机制
- 缓存计算结果
- 避免重复计算
- 条件性更新

### 3. 数据平滑
- 移动平均队列
- 减少传感器噪声
- 稳定控制输出

### 4. 条件执行
- 根据状态决定执行哪些模块
- 跳过不必要的计算
- 按需更新数据

## 安全机制 (Safety Mechanisms)

### 1. 引爆安全
- 碰炸解锁距离检查
- 防止近距离意外引爆
- 分级引爆序列

### 2. 控制限制
- PID输出限幅
- 积分抗饱和
- 陀螺仪转速限制

### 3. 错误处理
- 空值检查
- 除零保护
- 异常状态恢复

## 扩展性设计 (Extensibility)

### 模块化结构
每个子系统独立封装，易于：
- 单独测试
- 功能扩展
- 参数调整
- 算法替换

### 参数化配置
所有关键参数可配置，支持：
- 不同类型导弹
- 不同战术需求
- 性能优化
- 行为定制

## 依赖关系图 (Dependency Graph)

```
Program
  ├── 参数管理器 (独立)
  ├── 导弹识别器 ← 参数管理器
  ├── 导弹状态量 (独立)
  ├── TargetTracker ← 参数管理器
  ├── 推进系统 ← 参数管理器
  └── 陀螺仪系统 ← 参数管理器
      └── PID3 ← PID
```

## 未来改进方向 (Future Improvements)

1. **算法优化**
   - 更精确的质量估算
   - 改进的运动预测
   - 自适应PID参数

2. **功能扩展**
   - 摄像头支持
   - 多目标处理
   - 协同制导

3. **性能提升**
   - 更高效的BFS算法
   - 减少内存分配
   - 优化数学计算

---

本文档描述了AI主动弹制导系统的完整架构。如需更详细的实现细节，请参考源代码注释。
